<!-- src/routes/NavBar.svelte -->
<script lang="ts">
    import { page } from '$app/stores';
    import { enhance } from '$app/forms';
    import { invalidateAll } from '$app/navigation';
    import { auth } from '$lib/stores';
    import { get } from 'svelte/store';
    import CaretDown from "phosphor-svelte/lib/CaretDown";
    import type { Session } from '@auth/core/types';
    import { signIn, signOut } from '@auth/sveltekit/client';
    import { onMount } from 'svelte';
      
    let isMenuOpen = false;
    let isProfileOpen = false;
    let isProjectMenuOpen = false;
    let session: Session | null = null;
    let menuContainer: HTMLElement;

    $: session = $auth;
    $: if (session) {
        console.log('[NavBar] Session:', {
            isAuthenticated: true,
            user: session.user,
            expires: session.expires
        });
    }
      
    function handleLinkClick() {
        isMenuOpen = false;
        isProfileOpen = false;
        isProjectMenuOpen = false;
    }
  
    async function handleSignOut() {
        try {
            await signOut({ callbackUrl: '/' });
            await invalidateAll();
            isProfileOpen = false;
            isMenuOpen = false;
        } catch (error) {
            console.error('[NavBar] Sign-out error:', error);
            window.location.href = '/';
        }
    }

    async function handleSignIn(e: Event) {
        e.preventDefault();
        try {
            await signIn('google', { callbackUrl: window.location.pathname });
        } catch (error) {
            console.error('[NavBar] Sign-in error:', error);
        }
    }
  
    function toggleProfileMenu() {
        isProfileOpen = !isProfileOpen;
        isProjectMenuOpen = false;
    }

    function toggleProjectMenu() {
        isProjectMenuOpen = !isProjectMenuOpen;
        isProfileOpen = false;
    }

    function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
            isProfileOpen = false;
            isProjectMenuOpen = false;
        }
    }

    function handleClickOutside(event: MouseEvent) {
        if (menuContainer && !menuContainer.contains(event.target as Node)) {
            isMenuOpen = false;
            isProjectMenuOpen = false;
        }
    }
</script>

<svelte:window on:click={handleClickOutside} />

<nav class="fixed top-0 w-full z-50 pb-8 px-0">
    <div class={`backdrop-blur-sm bg-zinc-100/30 py-8 relative z-[60] ${isMenuOpen ? 'bg-zinc-100' : ''}`}>
        <div class="max-w-5xl mx-auto px-4 sm:px-[22px]">
            <div class="flex items-center h-[96px]">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="/" class="relative z-[100] block">
                        <img
                            src="/images/tmg_flags.png"
                            alt="TMG Logo"
                            class="h-12 w-auto"
                        />
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex flex-grow justify-center">
                    <div class="flex items-center space-x-10">
                        <a href="/explore-designs" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">
                            Explore Designs
                        </a>
                        <!-- Hire a tradesperson dropdown -->
                        <div class="relative">
                            <button 
                                on:click={toggleProjectMenu}
                                class="flex items-center space-x-1 text-sm text-gray-600 hover:text-gray-900 transition-colors focus:outline-none"
                            >
                                <span>Hire a tradesperson</span>
                                <CaretDown size={16} />
                            </button>

                            {#if isProjectMenuOpen}
                                <div class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                                    <div class="py-1" role="menu">
                                        <a
                                            href="/start-project"
                                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                            role="menuitem"
                                            on:click={handleLinkClick}
                                        >
                                            Submit a project
                                        </a>
                                    </div>
                                </div>
                            {/if}
                        </div>
                        <a href="/pricing" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">
                            Pricing
                        </a>
                    </div>
                </div>

                <!-- Desktop Auth -->
                <div class="hidden md:flex items-center">
                    <div class="ml-auto">
                        {#if session?.user}
                            <div class="relative">
                                <button 
                                    on:click={toggleProfileMenu}
                                    class="flex items-center space-x-2 focus:outline-none"
                                >
                                    <img
                                        src={session.user.image || '/images/default-avatar.png'}
                                        alt={session.user.name || 'User avatar'}
                                        class="h-8 w-8 rounded-full"
                                    />
                                    <span class="text-sm font-medium text-gray-600">{session.user.name}</span>
                                    <CaretDown size={16} class="text-gray-600" />
                                </button>

                                {#if isProfileOpen}
                                    <div class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                                        <div class="py-1" role="menu">
                                            <a
                                                href="/profile"
                                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                role="menuitem"
                                                on:click={handleLinkClick}
                                            >
                                                Profile
                                            </a>
                                            <button
                                                on:click={handleSignOut}
                                                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                role="menuitem"
                                            >
                                                Sign out
                                            </button>
                                        </div>
                                    </div>
                                {/if}
                            </div>
                        {:else}
                            <button
                                on:click={handleSignIn}
                                class="text-sm text-gray-600 hover:text-gray-900 transition-colors"
                            >
                                Sign in
                            </button>
                        {/if}
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden ml-auto">
                    <button
                        on:click={toggleMenu}
                        class="text-gray-600 hover:text-gray-900 transition-colors p-2 relative w-[20px] h-[20px]"
                    >
                        <span class="sr-only">Open menu</span>
                        <!-- Menu Icon -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class={`w-5 h-0.5 bg-current transition-all ${isMenuOpen ? 'rotate-45' : ''}`} />
                            <div class={`w-5 h-0.5 bg-current transition-all ${isMenuOpen ? '-rotate-45' : ''}`} />
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div 
        class={`md:hidden fixed inset-0 z-50 bg-zinc-100 px-8 transition-all duration-300 ease-in-out ${
            isMenuOpen ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-full pointer-events-none'
        }`}
        bind:this={menuContainer}
    >
        <div class="flex flex-col items-center justify-center min-h-screen space-y-8">
            <a
                href="/explore-designs"
                class="text-2xl font-medium text-gray-900 hover:text-gray-600 transition-colors"
                on:click={handleLinkClick}
            >
                Explore Designs
            </a>
            <a
                href="/start-project"
                class="text-2xl font-medium text-gray-900 hover:text-gray-600 transition-colors"
                on:click={handleLinkClick}
            >
                Submit a project
            </a>
            <a
                href="/pricing"
                class="text-2xl font-medium text-gray-900 hover:text-gray-600 transition-colors"
                on:click={handleLinkClick}
            >
                Pricing
            </a>
            {#if session?.user}
                <button
                    on:click={handleSignOut}
                    class="text-2xl font-medium text-gray-900 hover:text-gray-600 transition-colors"
                >
                    Sign out
                </button>
            {:else}
                <button
                    on:click={handleSignIn}
                    class="text-2xl font-medium text-gray-900 hover:text-gray-600 transition-colors"
                >
                    Sign in
                </button>
            {/if}
        </div>
    </div>
</nav>